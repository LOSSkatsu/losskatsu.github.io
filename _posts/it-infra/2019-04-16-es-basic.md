---
title: "[Infra] 엘라스틱서치(ElasticsSearch) 정리" 
categories:
  - it-infra
tags:
  - it-infra
use_math: true
toc: true
toc_label: "My Table of Contents"
toc_icon: "cog"
sidebar:
  title: "AI Machine Learning"
  nav: sidebar-contents
---

# 엘라스틱서치(elastics search) 정리

## 1. 클러스터 운영 관련 정보

클러스터 정보 확인

status: red, yellow, green

클러스터를 재가동할 경우, active_shards_percent_as_number가 처음에 NaN에서 서서히 올라가기 시작한다. 
동시에 unassigned_shards는 줄어들기 시작한다. 

```bash
$ curl http://localhost:9200/_cluster/health?pretty=true
{
  "cluster_name" : "~~~",
  "status" : "green",
  "timed_out" : "false",
  "number_of_nodes" : 6,
  "number_of_data_nodes" : 5,
  "active_primary_shards" : 341,
  "active_shards" : 682,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 0,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_milis" : 0,
  "active_shards_percent_as_number" : 100.0
}
```

### 1-1. 현재 진행중인 task 확인 

참고: [task 확인](https://www.elastic.co/guide/en/elasticsearch/reference/current/tasks.html)

```bash
$ curl http://localhost:9200/_cat/task?pretty
```

혹은 더 자세하게 보고 싶다면 아래와 같이 입력 
 
```bash
$ curl http://localhost:9200/_tasks?pretty 
```

### 1-2. 현재 ES 노드별 힙(heap) 사용량 확인

참고링크1: [힙 사용량 확인1](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-nodes.html)
참고링크2: [힙 사용량 확인2](https://discuss.elastic.co/t/how-to-check-es-heap-size/36613/5)

```bash
$ curl -XGET http://localhost:9200/_cat/nodes?v
heap.current heap.percent heap.max 
11.6gb 36 31.8gb
21.8gb 68 31.8gb
19.4gb 61 31.8gb
 6.7gb 21 31.8gb
21.6gb 68 31.8gb
11.9gb 37 31.8gb
```

### 1-3. 수행중인 task 취소

참고: [수행중인 task 취소](https://www.elastic.co/guide/en/elasticsearch/reference/current/tasks.html#task-cancellation)


### 1-4.샤드&레플리카

샤드 & 리플리카편집
색인은 방대한 양의 데이터를 저장할 수 있는데, 이 데이터가 단일 노드의 하드웨어 한도를 초과할 수도 있습니다. 예를 들어 10억 개의 문서로 구성된 하나의 색인에 1TB의 디스크 공간이 필요할 경우, 단일 노드의 디스크에서 수용하지 못하거나 단일 노드에서 검색 요청 처리 시 속도가 너무 느려질 수 있습니다.

Elasticsearch는 이러한 문제를 해결하고자 색인을 이른바 샤드(shard)라는 조각으로 분할하는 기능을 제공합니다. 색인을 생성할 때 원하는 샤드 수를 간단히 정의할 수 있습니다. 각 샤드는 그 자체가 온전한 기능을 가진 독립적인 "색인"이며, 클러스터의 어떤 노드에서도 호스팅할 수 있습니다.

샤딩은 무엇보다도 2가지 이유로 중요합니다.

* 콘텐츠 볼륨의 수평 분할/확장이 가능해집니다.
* 작업을 (어쩌면 여러 노드에 위치한) 여러 샤드에 분산 배치하고 병렬화함으로써 성능/처리량을 늘릴 수 있습니다.
샤드가 분산 배치되는 방식 및 그 문서가 다시 검색 요청으로 집계되는 방식의 메커니즘은 모두 Elasticsearch에서 관리하며 사용자에게는 투명하게 이루어집니다.

언제든 오류가 일어날 가능성이 있는 네트워크/클라우드 환경에서는 어떤 이유에서든 샤드/노드가 오프라인 상태가 되거나 사라지게 될 경우에 대비하여 페일오버 메커니즘을 마련하는 것이 매우 유익하고 바람직합니다. 이러한 취지에서 Elasticsearch에서는 색인의 샤드에 대해 하나 이상의 복사본을 생성할 수 있는데, 이를 리플리카 샤드(replica shard), 줄여서 리플리카라고 합니다.

이처럼 리플리카를 만드는 복제는 무엇보다도 2가지 이유로 중요합니다.

샤드/노드 오류가 발생하더라도 고가용성을 제공합니다. 따라서 리플리카 샤드는 그 원본인 기본 샤드와 동일한 노드에 배정되지 않습니다.
모든 리플리카에서 병렬 방식으로 검색을 실행할 수 있으므로 검색 볼륨/처리량을 확장할 수 있습니다.
요약하자면 각 색인은 여러 개의 샤드로 분할할 수 있습니다. 또한 하나의 색인은 복제하지 않거나(리플리카 없음) 1회 이상 복제할 수 있습니다. 복제되면 각 색인은 기본 샤드(복제 원본 샤드)와 리플리카 샤드(기본 샤드의 복사본)를 갖습니다. 샤드 및 리플리카의 수는 색인별로, 색인 생성 시점에 정의할 수 있습니다. 색인이 생성된 다음 언제라도 탄력적으로 리플리카의 수를 변경할 수 있으나, 샤드 수는 사후 변경이 불가합니다.

기본적으로 Elasticsearch의 각 색인은 기본 샤드 5개, 리플리카 1개를 갖습니다. 따라서 클러스터에 최소한 2개의 노드가 있다면 색인은 기본 샤드 5개, 리플리카 샤드 5개(완전한 리플리카 1개)를 가지므로 색인당 총 10개의 샤드가 존재하게 됩니다.


## 2. 멀티 테넌시(Multi Tenancy)

관계형 디비에서 다른 데이터베이스의 데이터를 검색하려면 별도의 컨넥션을 생성해야하는 것과 달리 
엘라스틱서치에서는 데이터를 검색할 때 서로 다른 인덱스의 데이터를 바로 하나의 질의로 묶어서 검색하고 
여러 검색 결과를 하나의 출력으로 도출 할 수 있다. 이를 멀티 테넌시(Multi Tenancy)라고 한다.

관계형DB | 엘라스틱서치
-------------|---------
데이터베이스(database) | 인덱스(index)
테이블(table) | 타입(type)
열(row) | 도큐먼트(document)
행(column) | 필드(field)
스키마(schema) | 매핑(Mapping)

HTTP Method | CRUD | SQL
-----------|--------|-----
GET | Read | Select
PUT | Update | Update
POST | Create | Insert
DELETE | Delete | Delete


## 3. 유닉스에서 엘라스틱서치의 REST API를 이용한 curl 명령

```bash
curl -X{메소드} http://host:port/{인덱스}/{타입}/{도큐먼트 id} -d ‘{데이터}’ 
```

## 4. 엘라스틱 서치 템플릿(template) 확인 

엘라스틱 서치의 템플릿(template)은 RDBMS의 스키마와 같은 것이라고 생각하면 편하다. 

* 사용법

```bash
curl 'http://localhost:9200/{인덱스명}/_mapping?pretty'
```

* 사용 예(abcde라는 인덱스의 템플릿을  싶을때)

```bash
curl 'http://localhost:9200/abcde/_mapping?pretty'
```

* abcd 라는 인덱스 확인

```bash
curl localhost:9200/abcd/
```

* abcd 라는 인덱스 삭제

```bash
curl -XDELETE http://localhost:9200/abcd
```

* 초기에 템플릿 포함해서 abcd 라는 인덱스 생성
* 쉘 스크립트를 하나 만드는게 좋은듯

```bash
curl -XPUT http://localhost:9200/abcd/ -d '
{
  "order": 0,
  "template": "abcd",
  "setting": {},
  "mapping": {
      "_default_": {
          "properties": {
                  
                  실제 필드들~~~~
          
          }
      }
   }
}'
```

## 5. 메타 필드(Meta Fields)

메타필드 | 설명
--------|------
\_index | 해당 문서가 속한 인덱스의 이름을 담고 있다.
\_type | 해당 문서가 속한 매핑의 타입 정보를 담고 있다. 
\_id | 문서를 식별하는 유일한 키값. 한 인덱스에서 색인된 문서마다 서로 다른 키값을 가짐. RDB 에서의 PRIMARY KEY라고 보면 될 듯. 이 값은 int, long, 상관없이 무조건 string으로 저장된다.
\_uid | 특수 목적 식별키. "#" 태그를 이용해 \_type과 \_id 값을 조합해 사용함. 하지만 내부적으로 사용되기 때문에 조회시 검색되진 않음. 
\_source | 문서의 원본 데이터를 제공함.
\_all | 색인에 사용된 모든 필드의 정보를 가진 메타 필드.
\_routing | 특정 문서를 특정 샤드에 저장하기 위해 사용하는 메타필드. 
